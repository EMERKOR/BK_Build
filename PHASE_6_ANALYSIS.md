# Phase 6: End-to-End Backtest Verification + v1.3 Planning

**Session ID**: 01MXuERkhfwpGSJ4EYRgBEb9
**Branch**: `claude/bk-phase6-verification-01MXuERkhfwpGSJ4EYRgBEb9`
**Date**: November 19, 2025
**Status**: âœ… Analysis Complete - Ready for Phase 7 Implementation

---

## Executive Summary

This phase performed comprehensive static analysis of the Ball Knower backtest pipeline to verify current functionality and plan v1.3 enhancements. **No code was modified** - this is pure documentation and planning.

**Key Findings**:
- âœ… v1.2 backtest pipeline is functional and produces MAE/RMSE metrics
- âœ… Leakage validation framework exists but is not actively enforced
- âœ… Calibration hardening is active (fails loud if model file missing)
- âš ï¸ Professional betting metrics (units won, ROI, CLV) exist but not integrated into CLI
- âš ï¸ Advanced features (rolling EPA, form, matchups) exist but unused in v1.2
- ğŸ“‹ Clear upgrade path to v1.3 identified

---

## 1. Current Pipeline Architecture

### Core Files Analyzed

| File | Purpose | Status |
|------|---------|--------|
| `src/run_backtests.py` | Unified backtest CLI | âœ… Working (limited metrics) |
| `ball_knower/datasets/v1_2.py` | v1.2 dataset builder | âœ… Stable (6 features) |
| `ball_knower/features/engineering.py` | Feature engineering | âœ… Rich but underutilized |
| `src/models.py` | Model classes | âš ï¸ Not used by backtests |
| `archive/ball_knower_v1_2.py` | Actual v1.2 training | âœ… Works (archived) |
| `archive/backtest_v1_2.py` | Professional backtest | âœ… Has PnL/CLV (archived) |
| `src/betting_utils.py` | Betting calculations | âœ… Comprehensive |

### Features Currently Used in v1.2

**Total**: 6 features (all from NFElo modifiers)

1. `nfelo_diff` - ELO rating differential (home - away)
2. `rest_advantage` - Combined bye week effects (via canonical function)
3. `div_game` - Division game modifier
4. `surface_mod` - Surface differential modifier
5. `time_advantage` - Time zone advantage modifier
6. `qb_diff` - QB adjustment differential (538 EPA)

**Target**: `vegas_closing_spread` (market consensus line)

**Intentionally Unused** (for leak detection):
- `home_points`, `away_points`, `home_margin`

### Features Available But Unused

`ball_knower/features/engineering.py` provides:
- âœ… Rolling EPA (offense, defense, margin) - windows [3, 5, 10]
- âœ… Recent form (win rate, ATS rate, point diff) - windows [3, 5]
- âœ… Matchup features (offense vs opponent defense)
- âœ… Schedule-based rest days (alternative to NFElo bye mods)

**These are NOT used in v1.2 dataset builder** â† Major opportunity for v1.3

---

## 2. Leakage Validation Status

### âœ… Canonical Rest Advantage
- Function: `ball_knower.features.engineering.compute_rest_advantage_from_nfelo()`
- Location: engineering.py:23-47
- Used by: v1_2.py:88 âœ…
- Purpose: Single source of truth for rest calculation

### âœ… Leak Prevention in Rolling Features
- All rolling features use `.shift(1)` to exclude current game
- Rolling EPA: engineering.py:206-213 âœ…
- Rolling form: engineering.py:309-330 âœ…
- Proper time-based sorting before rolling operations

### âš ï¸ Validation Function Exists But Not Enforced
- Function: `ball_knower.features.engineering.validate_no_leakage()`
- Location: engineering.py:230-249
- Status: Defined but has placeholder `pass` statements
- **Gap**: Not called by v1_2.py dataset builder
- **Recommendation**: Complete implementation and integrate

### âœ… Test Coverage for Leak Detection
- Test: `tests/test_datasets.py::test_v1_2_intentionally_unused_columns()`
- Verifies: Intentionally unused columns exist and contain data
- Ensures: Models cannot accidentally use future information

---

## 3. Calibration Hardening Status

### âœ… Fail-Loud Model Loading
- Code: `src/run_backtests.py:128-137`
- Behavior: Raises `FileNotFoundError` if model JSON missing
- No silent fallback to default weights âœ…

### âœ… Model File Required
- Path: `output/ball_knower_v1_2_model.json`
- Format: JSON with intercept, coefficients, alpha, train/test metrics
- Generated by: `archive/ball_knower_v1_2.py` (training script)

### âœ… Test Coverage
- Test: `tests/test_calibrated_weights.py`
- Verifies: Models load weights from JSON
- Verifies: Predictions use calibrated values

---

## 4. Current Backtest Metrics

### What's Printed by `run_backtests.py`

**Per Season Metrics** (run_backtests.py:302-305):
- âœ… `season` - Season year
- âœ… `model` - Model version (v1.0 or v1.2)
- âœ… `edge_threshold` - Minimum edge for "betting"
- âœ… `n_games` - Total games in season
- âœ… `n_bets` - Games above edge threshold
- âœ… `mae_vs_vegas` - Mean absolute edge
- âœ… `rmse_vs_vegas` - Root mean squared edge
- âœ… `mean_edge` - Average signed edge

### What's MISSING from Official CLI

**Professional Betting Metrics** (requested in Phase A):
- âŒ `units_won` - Profit/loss in betting units
- âŒ `roi_pct` - Return on investment percentage
- âŒ `ats_win_rate` - Against-the-spread win rate
- âŒ `clv` - Closing line value

### Where These Metrics Exist

**File**: `archive/backtest_v1_2.py` (archived, not in official CLI)

**Calculations Present**:
- EV in dollars (lines 155-165)
- Kelly sizing (lines 167-177)
- Edge distribution analysis (lines 209-216)
- EV by edge threshold (lines 223-238)
- Kelly analysis by threshold (lines 242-258)
- Performance by season (lines 263-274)

**Utility Functions Available**:
- `src/betting_utils.py::calculate_ev()` âœ…
- `src/betting_utils.py::kelly_criterion()` âœ…
- `src/betting_utils.py::calculate_clv()` âœ…

**Gap**: Professional metrics exist but not integrated into official CLI â† High-priority for v1.3

---

## 5. Full Pipeline Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATA LOADING PHASE                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
          [NFElo Historical Games CSV (remote)]
                                  â”‚
                                  â–¼
                  [Parse game_id â†’ season, week, teams]
                  [Filter: home_line_close.notna()]
                  [Filter: nfelo ratings.notna()]
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DATASET BUILDER (v1.2)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
              [Feature Engineering - 6 features]
                                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                  â–¼           â–¼                â–¼
    nfelo_diff      rest_advantage  div_game      surface_mod
         â”‚                  â”‚           â”‚                â”‚
         â”‚          (canonical fn)      â”‚                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
              [Target: vegas_closing_spread]
              [Intentionally unused: home_points, etc.]
              [Filter: Remove NaN rows]
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     MODEL PREDICTION                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
         [Load model: ball_knower_v1_2_model.json]
                   (Fail loud if missing)
                                  â”‚
                                  â–¼
         [Ridge regression: intercept + Î£(feature Ã— coef)]
                                  â”‚
                                  â–¼
              [Prediction: bk_v1_2_spread]
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ERROR CALCULATION                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
         [Edge = bk_v1_2_spread - vegas_line]
         [Abs Edge = |edge|]
         [Filter: Bets = games where abs_edge >= threshold]
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   METRICS COMPUTATION                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
         [Per Season Aggregation]
                                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼              â–¼                    â–¼               â–¼
    MAE vs Vegas   RMSE vs Vegas       Mean Edge       N Games/Bets
         â”‚              â”‚                    â”‚               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PnL & CLV (NOT IMPLEMENTED)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
         âŒ Units Won (would need ATS outcomes)
         âŒ ROI (would need -110 juice calculation)
         âŒ CLV (would need opening lines)
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUMMARY REPORTING                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
         [CSV Output: backtest_{model}_{years}.csv]
         [Console: Summary table by season]
```

---

## 6. Critical Gaps for v1.3

### Gap 1: Feature Set Underutilization
**Current**: v1.2 uses 6 static NFElo modifiers
**Available**: 20+ advanced features in engineering.py (unused)
**Impact**: Missing predictive power from EPA, form, matchups
**Recommendation**: Integrate advanced features in v1.3

### Gap 2: Missing Professional Metrics
**Current**: Backtest prints MAE/RMSE only
**Required**: Units won, ROI, ATS win rate, CLV
**Impact**: Cannot evaluate betting profitability
**Recommendation**: Integrate betting_utils calculations into CLI

### Gap 3: Target Definition Ambiguity
**v1.0**: Predicts `actual_margin` (football truth)
**v1.2**: Predicts `vegas_closing_spread` (market consensus)
**v1.3**: ??? Need to decide strategy
**Recommendation**: Continue market-calibrated approach (predict spread)

### Gap 4: Leakage Validation Not Enforced
**Current**: `validate_no_leakage()` exists but not called
**Risk**: Accidental data leakage in new features
**Recommendation**: Complete implementation and add to v1.3 builder

### Gap 5: Opening Line Data Unavailable
**Required for CLV**: Opening spread lines
**Available in NFElo**: âŒ Only closing lines
**Impact**: Cannot calculate true closing line value
**Recommendation**: Defer CLV to future phase OR find new data source

### Gap 6: Score Modeling Not Supported
**Current**: Spread-only prediction
**Alternative**: Independent home/away score models â†’ derive spread
**Benefit**: Can predict totals, alternate spreads
**Recommendation**: Defer to v2.0 (separate project)

### Gap 7: Model Architecture Fragmentation
**Issue**: v1.0/v1.1/v1.2 classes in `src/models.py` are not used
**Actual v1.2**: Trained by `archive/ball_knower_v1_2.py` script
**Confusion**: Two different "v1.2" implementations
**Recommendation**: Create `ball_knower/models/` package for v1.3

### Gap 8: Test Coverage for PnL Metrics
**Current**: No tests for units_won, ROI, ATS calculations
**Risk**: Incorrect betting math goes undetected
**Recommendation**: Add `tests/test_ats_pnl.py`

### Gap 9: Data Requirements Not Documented
**For v1.3 EPA features**: Need play-by-play data via `nfl_data_py`
**For v1.3 ATS features**: Need historical schedules via `nfl_data_py`
**Current**: Not documented in requirements
**Recommendation**: Update README with data dependencies

---

## 7. Stable vs Fragile Components

### âœ… Stable (Safe to Depend On)
- Data loading (`ball_knower/io/loaders.py`)
- Team name normalization (`src/team_mapping.py`)
- Canonical rest advantage (`engineering.compute_rest_advantage_from_nfelo`)
- Betting utilities (`src/betting_utils.py`)
- Configuration (`src/config.py`)
- Test fixtures (`tests/fixtures/`)

### âš ï¸ Fragile (Handle with Care)
- Model JSON format (hardcoded in multiple places)
- NFElo column names (external dependency)
- Feature list maintenance (duplicated in v1_2.py, run_backtests.py, ball_knower_v1_2.py)
- Archive script reliance (ball_knower_v1_2.py not in official package)

### ğŸ”´ Brittle (Needs Refactoring)
- Model class architecture (v1.0/v1.1/v1.2 classes unused)
- Feature engineering integration (manual copy-paste in builders)
- Metric calculation (scattered across files)

---

## 8. Recommended v1.3 Project Plan

### **Phase 7 Goals**

**Primary Objective**: Enhance v1.2 with advanced features and professional betting metrics

**Specific Deliverables**:
1. New dataset builder: `ball_knower/datasets/v1_3.py` with 20+ features
2. Integrate rolling EPA, recent form, matchup features
3. Add ATS PnL and ROI calculations to backtest CLI
4. Complete and enforce leakage validation
5. Achieve MAE < 1.8 points vs Vegas (improve over v1.2)

**Out of Scope**:
- Score modeling (defer to v2.0)
- Opening line integration (data unavailable)
- Multi-target modeling (defer to v2.0)

### **Implementation Plan: 5 Sequential Steps**

#### **Step 1: Dataset Builder** (`claude/phase7-step1-dataset-builder`)
**Files to Create**:
- `ball_knower/datasets/v1_3.py` - New builder with 20+ features
- `tests/test_v1_3_dataset.py` - Dataset validation tests

**New Features to Add**:
```python
# Rolling EPA (9 features)
'epa_off_L3', 'epa_off_L5', 'epa_off_L10'
'epa_def_L3', 'epa_def_L5', 'epa_def_L10'
'epa_margin_L3', 'epa_margin_L5', 'epa_margin_L10'

# Recent Form (6 features)
'win_rate_L3', 'win_rate_L5'
'ats_rate_L3', 'ats_rate_L5'
'point_diff_L3', 'point_diff_L5'

# Matchups (2 features)
'home_off_vs_away_def', 'away_off_vs_home_def'
```

**Data Sources Needed**:
- NFElo historical games (existing)
- NFL play-by-play data (via `nfl_data_py`) - NEW
- Historical schedules (via `nfl_data_py`) - NEW

**Tests Required**:
- `test_v1_3_has_rolling_features()` - Verify all features present
- `test_v1_3_first_games_have_nan()` - Verify warmup period
- `test_v1_3_no_leakage()` - Verify validation passes

---

#### **Step 2: Feature Engineering** (`claude/phase7-step2-feature-engineering`)
**Files to Modify**:
- `ball_knower/features/engineering.py`

**Changes**:
1. **Complete `validate_no_leakage()` implementation**:
```python
def validate_no_leakage(df, date_col='gameday'):
    """
    Validate that rolling features don't leak future information.

    Checks:
    1. No same-row leakage (rolling features exclude current game)
    2. First N games per team have NaN in L{N} features (warmup)
    3. Proper chronological sorting

    Raises:
        ValueError: If leakage detected
    """
    # Implementation with actual validation logic
```

2. **Add convenience function**:
```python
def engineer_v1_3_features(schedules, weekly_stats):
    """One-stop feature engineering for v1.3 with validation"""
    schedules = calculate_rolling_epa(schedules, weekly_stats, windows=[3,5,10])
    schedules = calculate_recent_form(schedules, windows=[3,5])
    schedules = create_matchup_features(schedules, team_ratings)
    validate_no_leakage(schedules)  # Enforce validation
    return schedules
```

**Tests Required**:
- `test_validate_no_leakage_catches_same_row()` - Verify detection
- `test_validate_no_leakage_catches_wrong_sort()` - Verify detection
- `test_engineer_v1_3_features_integration()` - End-to-end test

---

#### **Step 3: Model Training** (`claude/phase7-step3-model-training`)
**Files to Create**:
- `ball_knower/models/__init__.py` - New models package
- `ball_knower/models/v1_3.py` - v1.3 model class
- `train_v1_3.py` - Training script (project root)

**Model Architecture**:
```python
class BallKnowerV1_3:
    """
    Enhanced Ridge regression with 20+ features.

    Features: v1.2 features (6) + EPA (9) + form (6) + matchup (2) = 23 total
    Target: vegas_closing_spread
    Algorithm: Ridge with TimeSeriesSplit CV
    """

    def fit(self, X, y, cv_splits=5):
        """Fit with alpha tuning via cross-validation"""

    def predict(self, X):
        """Generate spread predictions"""

    def save_model(self, path):
        """Save to JSON (compatible with run_backtests.py)"""
```

**Output**:
- `output/ball_knower_v1_3_model.json` - Trained model
- Console report with feature importance, CV results, test metrics

**Tests Required**:
- `test_v1_3_model_fit_and_predict()` - Basic functionality
- `test_v1_3_model_save_load()` - Serialization
- `test_v1_3_feature_importance()` - Verify coefficients

---

#### **Step 4: Backtest Metrics** (`claude/phase7-step4-backtest-metrics`)
**Files to Modify**:
- `src/run_backtests.py` - Add v1.3 support and PnL metrics
- `src/betting_utils.py` - Add ATS/units/ROI functions

**New Functions in `betting_utils.py`**:
```python
def calculate_ats_outcome(actual_margin, spread_line):
    """Did the bet cover the spread?"""
    # Home team covers if: actual_margin + spread_line > 0
    return (actual_margin + spread_line) > 0

def calculate_units_won(ats_outcomes, stakes=1.0, juice=-110):
    """Calculate units won given ATS outcomes and juice"""
    wins = ats_outcomes.sum()
    losses = (~ats_outcomes).sum()
    units_won = (wins * 0.909) - (losses * 1.1)  # Assuming -110 juice
    return units_won

def calculate_roi(units_won, units_risked):
    """ROI = (units_won / units_risked) * 100"""
    return (units_won / units_risked) * 100
```

**New Function in `run_backtests.py`**:
```python
def run_backtest_v1_3(start_season, end_season, edge_threshold):
    """Backtest v1.3 with full ATS PnL metrics"""
    # ... existing backtest logic ...

    # NEW: Calculate ATS outcomes
    df['ats_outcome'] = calculate_ats_outcome(
        df['actual_margin'],
        df['vegas_line']
    )

    # NEW: Calculate units and ROI per season
    season_results['units_won'] = ...
    season_results['roi_pct'] = ...
    season_results['ats_win_rate'] = ...

    return season_results
```

**CLI Update**:
```python
parser.add_argument('--model', choices=['v1.0', 'v1.2', 'v1.3'])
```

**Tests Required**:
- `test_ats_outcome_calculation()` - Verify spread covering logic
- `test_units_won_with_juice()` - Verify -110 juice math
- `test_roi_calculation()` - Verify ROI formula
- `test_backtest_v1_3_includes_pnl_metrics()` - Integration test

---

#### **Step 5: Validation** (`claude/phase7-step5-validation`)
**Files to Modify**:
- `README.md` - Update with v1.3 results

**Activities**:
1. Run full backtests: `python src/run_backtests.py --start-season 2019 --end-season 2024 --model v1.3 --edge-threshold 1.0`
2. Compare v1.2 vs v1.3:
   - MAE improvement
   - RMSE improvement
   - ROI by edge threshold
   - ATS win rate
3. Generate performance visualizations
4. Update documentation with findings

**Success Criteria**:
- v1.3 MAE < v1.2 MAE (improvement)
- ROI > 0 at edge threshold >= 1.5 points
- ATS win rate > 52.38% (break-even at -110)
- All tests passing

---

### **Branch Strategy**

```
main (protected)
 â”‚
 â””â”€â”€â”€ claude/phase7-v1_3-integration  (integration branch)
       â”‚
       â”œâ”€â”€â”€ claude/phase7-step1-dataset-builder âœ…
       â”‚     â””â”€ PR â†’ phase7-integration
       â”‚
       â”œâ”€â”€â”€ claude/phase7-step2-feature-engineering âœ…
       â”‚     â””â”€ PR â†’ phase7-integration
       â”‚
       â”œâ”€â”€â”€ claude/phase7-step3-model-training âœ…
       â”‚     â””â”€ PR â†’ phase7-integration
       â”‚
       â”œâ”€â”€â”€ claude/phase7-step4-backtest-metrics âœ…
       â”‚     â””â”€ PR â†’ phase7-integration
       â”‚
       â””â”€â”€â”€ claude/phase7-step5-validation âœ…
             â””â”€ PR â†’ phase7-integration
             â””â”€ phase7-integration â†’ main (final merge)
```

**Rationale**:
- Small, testable PRs (1-3 files each)
- Integration branch allows testing combinations
- Can roll back individual steps if needed
- Clear progression with checkpoints

---

### **File Count Summary**

**New Files**: 6 files
1. `ball_knower/datasets/v1_3.py`
2. `ball_knower/models/__init__.py`
3. `ball_knower/models/v1_3.py`
4. `train_v1_3.py`
5. `tests/test_v1_3_dataset.py`
6. `tests/test_ats_pnl.py`

**Modified Files**: 4 files
1. `ball_knower/features/engineering.py` - Complete validation
2. `src/run_backtests.py` - Add v1.3 + PnL metrics
3. `src/betting_utils.py` - Add ATS/units/ROI
4. `tests/test_backtest_cli.py` - Add v1.3 tests

**Stable (No Changes)**: ~10 files
- All v1.2 dataset and model code
- All data loaders
- All configuration
- All existing tests

---

## 9. Open Questions for User

Before proceeding to Phase 7 implementation, clarify:

1. **Target Strategy**: Continue market-calibrated spread prediction (recommended) OR pivot to football-truth margin prediction?

2. **Feature Scope**: Integrate all 20+ advanced features OR selective subset based on correlation analysis?

3. **CLV Calculation**: Defer CLV until opening line data source found OR proceed without CLV metrics?

4. **Score Modeling**: Keep v1.3 spread-only OR explore home/away score predictions (major architecture change)?

5. **Archived Code**: Integrate professional backtest metrics from `archive/backtest_v1_2.py` OR rewrite from scratch?

6. **Model Classes**: Refactor `src/models.py` classes OR leave as-is (they're not used anyway)?

---

## 10. Phase 6 Completion Checklist

- âœ… Synced repo and created verification branch
- âœ… Read and analyzed all core pipeline files
- âœ… Identified all 6 features feeding into v1.2
- âœ… Confirmed leakage validation is reachable (but not enforced)
- âœ… Confirmed calibration hardening is active (fail loud)
- âœ… Verified backtest metrics (MAE, RMSE, edge only - missing PnL)
- âœ… Created full pipeline flow diagram
- âœ… Identified 9 critical gaps for v1.3
- âœ… Produced detailed 5-step implementation plan
- âœ… Documented stable vs fragile components
- âœ… Listed open questions for user decision

---

**Phase 6 analysis complete. Ready to begin Phase 7 when instructed.**

**Recommended Next Step**: User review this analysis and provide direction on open questions, then proceed with Step 1 (Dataset Builder) of Phase 7.
